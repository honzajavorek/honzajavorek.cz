<!DOCTYPE html>
<html lang="cs">
  <head prefix="og: https://ogp.me/ns# profile: https://ogp.me/ns/profile# article: https://ogp.me/ns/article#">
      <meta charset="utf-8">
    <link rel="canonical" href="https://honzajavorek.cz/blog/testovani-v-javascriptu-a-v-pythonu/">
    <title>Testování v JavaScriptu a v Pythonu &mdash; Honza Javorek</title>

      <script async src="https://www.googletagmanager.com/gtag/js?id=UA-1316071-6"></script>
      <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-1316071-6');
      </script>

    <meta property="og:title" content="Testování v JavaScriptu a v Pythonu &mdash; Honza Javorek">
    <meta property="og:url" content="https://honzajavorek.cz/blog/testovani-v-javascriptu-a-v-pythonu/">
    <meta name="twitter:creator" content="@honzajavorek">
    <meta name="twitter:site" content="@honzajavorek">

          <meta property="og:image" content="https://honzajavorek.cz/images/home/honza.jpg">
      <meta name="twitter:image" content="https://honzajavorek.cz/images/home/honza.jpg">
      <meta name="twitter:card" content="summary">


    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://honzajavorek.cz/theme/main.css">
    <link rel="stylesheet" href="https://honzajavorek.cz/theme/fork-awesome/css/fork-awesome.min.css">


  <link rel="stylesheet" href="https://honzajavorek.cz/theme/code.css">

    <link href="https://honzajavorek.cz/feed.xml" type="application/atom+xml" rel="alternate" title="Honza Javorek &mdash; Atom Feed">

      <link rel="alternate" hreflang="en" href="https://honzajavorek.cz/blog/testing-in-javascript-and-in-python">

  <meta property="og:type" content="article">
  <meta property="article:published_time" content="2016-05-31T10:43:00+02:00">
  <meta property="article:author" content="https://honzajavorek.cz">
  </head>
  <body>
      <div class="content">
<article class="article">
  <header class="article-header">
    <h1>
      <a href="https://honzajavorek.cz/blog/testovani-v-javascriptu-a-v-pythonu/" rel="bookmark">
        Testování v JavaScriptu a v Pythonu
      </a>
    </h1>
  </header>
  <footer class="article-info">
    <ul>
      <li class="article-translations">
        <small>
              Překlady:
              <a href="https://honzajavorek.cz/blog/testing-in-javascript-and-in-python" hreflang="en">en</a>
        </small>
      </li>
      <li class="article-published">
        <small>
          <time datetime="2016-05-31T10:43:00+02:00">
            31. 5. 2016
          </time>
        </small>
      </li>
      <li class="article-author">
        <small>
          <a href="#author">Honza Javorek</a>
        </small>
      </li>
    <ul>
  </footer>
  <div class="article-content">
      <div class="article-warning">
        <p>
          <strong>Upozornění!</strong> Tento článek vyšel
          před 4 lety.
          Můžete si jej přečíst v rámci zkoumání minulosti, ale přepokládejte,
          že dnes se Honza již nemusí s obsahem ztotožňovat.
        </p>
      </div>

    <div><p>Štve mě testování serverového JavaScriptu a v tomto článku vám napíšu proč. Pokud nemáte náladu na <a href="http://www.urbandictionary.com/define.php?term=rant">rant</a>, doporučuji si <a href="https://honzajavorek.cz/blog/">vybrat jiný článek</a>.</p>
<p>Jelikož jsem člověk původně ze světa Pythonu, srovnám <em>developer experience</em>
u obou jazyků, aby bylo jasnější, co přesně myslím. Ačkoliv jsem velkým
propagátorem jazyka Python, mým účelem není napsat hejt na JavaScript a zdůraznit,
že Python je nejlepší na světě. Chci pouze upozornit na nedostatek v jednom
z těchto dvou ekosystémů. Příště klidně napíšu článek o tom, jak mě štve
balíčkování v Pythonu a proč se mi mnohem víc líbí npm.</p>
<h2 id="testovani-v-pythonu">Testování v Pythonu<small class="permalink"><a href="#testovani-v-pythonu" title="Trvalý odkaz na tento nadpis">#</a></small></h2>
<p>Hodně lidí při psaní testů v Pythonu používá <a href="https://docs.python.org/3/library/unittest.html">unittest</a>,
modul ze základní knihovny, který lidem umožňuje rychle vytáhnout nějaký ten <a href="https://en.wikipedia.org/wiki/XUnit">XUnit</a>
způsob psaní testů, plný <code>class TestNěco</code>, <code>self.assertTamto()</code> a <code>setUp/tearDown</code>
tohleto.</p>
<p>Když je testů více, běžně si k tomu člověk vezme nějaký test runner,
třeba <a href="http://nose.readthedocs.io/en/latest/">nose</a>. Test runner je něco, co umí
inteligentně spouštět testy - např. jen ty, které posledně selhaly.</p>
<p>Protože nose testy spouští, umožňuje vyběhnout z XUnit stylu a nabízí spoustu
triků, jak můžete testy vylepšit a zjednodušit. Ty ale nikdo nepoužívá, protože
o nich neví. Nicméně v zásadě platí, že pokud chci pustit jen nějakou podmnožinu
testů, nebo chci upravit výstup testování, existuje na to chytrý přepínač. To je fajn především díky dvěma věcem:</p>
<ul>
<li>Konvence (kolega nemusí zjišťovat který konkrétní přepínač používám v tomto konkrétním projektu),</li>
<li>pohodlí a uživatelská příjemnost (přepínač je po ruce i když ho potřebuju třikrát za život).</li>
</ul>
<p>No a pak je tady <a href="http://pytest.org/">pytest</a>, což je framework, který zvládne nejspíš vše co nose,
ale navíc k trikům dává programátorům i úplně ulítlé možnosti, jak psát testy
jednoduše. Ačkoliv se v Pythonu <a href="https://www.python.org/dev/peps/pep-0020/">razí spíš <em>be explicit</em> a <em>no magic</em></a>, na oblibě pytestu
se ověřilo, že v případě testů je magie přijatelná a užitečná. Zvyšuje totiž
deklarativnost a čitelnost testů.</p>
<p>Protože za pytestem stojí i člověk, který napsal <a href="http://pypy.org/">PyPy</a>
(překladač Pythonu napsaný v Pythonu), je ta magie na poměrně hluboké úrovni.
Např. Python má klíčové slovo <code>assert</code>, které je ale v základu dost primitivní a umí akorát porovnat dvě
hodnoty a vyhodit obecnou chybu, pokud hodnoty nesedí. Totéž co <a href="https://nodejs.org/api/assert.html">funkce assert
v Node.js</a>. Co ale dělá pytest?
<a href="http://pybites.blogspot.co.at/2011/07/behind-scenes-of-pytests-new-assertion.html">Pomocí introspekce se hrabe v mezikódu Python interpreteru</a> a <a href="https://pytest.org/latest/assert.html">obohatí asserty</a> tak,
aby kontextově poznaly, co porovnávají, a podle toho vyhodily pěkné srovnání. Nepotřebuji tedy tahák na <code>assert.domysliSiSvojiPorovnávacíFunkci</code>, stačí mi používat
normální opetátory a typy, které se nacházejí v jazyce.</p>
<p>Také se mi líbí, že frameworky mají běžně v dokumentaci sekci o testování a nabízí mi
pomocnou ruku (tipy jak na to, nástroje, třídy k podědění) v tom, abych mohl svůj kód otestovat
snadněji, rychleji, a bez psaní zbytečně detailního <a href="https://en.wikipedia.org/wiki/Boilerplate_code">boilerplate kódu</a> okolo.
Viz <a href="http://flask.pocoo.org/docs/0.12/testing/">Flask</a>, <a href="https://docs.djangoproject.com/en/1.10/topics/testing/">Django</a>, <a href="https://doc.scrapy.org/en/latest/topics/contracts.html">Scrapy</a> (odkazy na dedikované kapitoly v dokumentaci).</p>
<p>Ve výsledku se při psaní testů cítím jako v bavlnce. Napíšu web v mikroframeworku,
ale i ten mi kód testů zjednoduší. Běžně je test jen na pár řádků, což šetří čas můj,
mého kolegy, který dělá code review, i všech ostatních, kdo budou ty testy v budoucnu číst. Testy si spustím z jaké složky chci a snadno
si spustím třeba jen ty, které mi posledně neprošly.</p>
<h2 id="mocha">Mocha<small class="permalink"><a href="#mocha" title="Trvalý odkaz na tento nadpis">#</a></small></h2>
<p>Ve světě serverového JavaScriptu, s jakým jsem měl tu čest se v <a href="https://apiary.io/">Apiary</a> seznámit, je zlatým standardem <a href="http://mochajs.org/">Mocha</a>. Tvrzení <em>feature-rich</em> v podtitulku znamená, že si máte doinstalovat i ten <a href="http://chaijs.com/">assert</a>. Ne, teď vážně. V Mocha vypadají <em>killer features</em> takto:</p>
<ul>
<li>Spouští všechny testy a když někam napíšu <code>.only</code>, spustím jen ten daný test,</li>
<li>umožňuje použít <em>glob patterns</em> pro výběr toho, jaké testy chci spouštět,</li>
<li>umožňuje grepovat přes popisky testů (když grep chytí víc popisků, spustí se víc testů),</li>
<li>jakože-<a href="https://en.wikipedia.org/wiki/Behavior-driven_development">BDD</a> přístup, který se skládá z <code>describe</code> a <code>it</code>,</li>
<li>tuny boilerplate kódu v <code>before</code> nebo <code>beforeEach</code> (protože <a href="https://github.com/mochajs/mocha/wiki/Shared-Behaviours"><em>Mocha currently has no concept of a shared behaviour...</em></a>),</li>
<li>když spadne test, někdy se ani nedovím, ve kterém souboru nastal problém,</li>
<li>dokumentace k uzoufání jen o něco méně než ta od <a href="http://mongoosejs.com/">Mongoose</a>,</li>
<li>vypisuje věci barvičkami a s unicode znakem ✔️, což je velmi cool,</li>
<li>umožňuje používat jen jeden reporter zaráz (hodně štěstí s generováním test coverage nebo <code>xunit.xml</code>).</li>
</ul>
<p>Pro srovnání, pytest:</p>
<ul>
<li>Žádné XUnit třídy, žádné hry na BDD, prostě <a href="http://docs.pytest.org/en/latest/getting-started.html#our-first-test-run">jednoduché funkce</a> s obyčejnými <a href="http://pytest.org/latest/assert.html">asserty</a>,</li>
<li>pomáhá odhalovat <a href="http://pytest.org/latest/example/reportingdemo.html">co se sakra děje</a>,</li>
<li>automatická <a href="http://pytest.org/latest/capture.html">správa <code>stdout</code> během testů</a>,</li>
<li>koncept <a href="http://pytest.org/latest/fixture.html">fixtures</a> pro psaní závislostí jednotlivých testů,</li>
<li><a href="http://pytest.org/latest/parametrize.html">parametrizace testů</a>,</li>
<li><a href="http://pytest.org/latest/xdist.html">distribuované testování</a>,</li>
<li>umí spouštět jakékoliv testy Python světa včetně <a href="http://pytest.org/latest/example/nonpython.html">nepythoních</a> nebo <a href="https://docs.python.org/3/library/doctest.html">testů dokumentace</a>.</li>
</ul>
<p>Že se Mocha nebo <a href="http://chaijs.com/">Chai</a> pomocí introspekce nehrabou v nějakém mezikódu jim nemůžu vyčítat, protože JavaScript
nemá ani introspekci, ani mezikód. Ten zbytek může Mocha nejspíš klidně naimplementovat, ale nedělá to. Je libo feature request na parametrizovatelnost testů (což považuji za základní
funkci obecného test frameworku) i s rantem o tom, jak Mocha maintaineři
nové features odmítají jako nepotřebné, nechávají je vyhnít, nedělají review apod.?
<a href="https://github.com/mochajs/mocha/issues/1454">Prosím</a>.</p>
<p>Jenže to není jen o maintainerech. Dobře, není nabídka, ale ona není ani poptávka. Z vyhledávání a issues na GitHubu mi přijde, že v Node.js ekosystému úplně chybí ambice takové funkce používat a požadovat. Většina pisatelů Mocha testů nejspíš ani neví, že tyto věci mohou existovat. Výsledkem je, že</p>
<ul>
<li>tyhle věci nenapíšou a nepošlou jako Pull Request nebo z toho neudělají balíček na npm,</li>
<li>ve větších test suites jejich testy živelně přerostou do 1000řádkových souborů plných boilerplate kódu, které se nedají ani číst, ani spouštět.</li>
</ul>
<p>Kdyby někde zahlédli že existuje něco jako parametrizace nebo správa fixtures,
třeba by je to trklo a zkusili by to použít, psát ty testy čistěji. Ale tím, že
to po ruce nemají, tak buď testy copy-pastují, nebo si pomůžou přes <code>forEach</code>
a všude naplácejí nějaké funkce na sdílení assertů. Nevím, který z těch dvou
přístupů je horší. První je čitelný, ale špatně spravovatelný, druhý je nečitelný,
byť alespoň iluzorně o něco lépe spravovatelný.</p>
<h2 id="npm-zachranuje-situaci-nebo-taky-ne">npm zachraňuje situaci - nebo taky ne<small class="permalink"><a href="#npm-zachranuje-situaci-nebo-taky-ne" title="Trvalý odkaz na tento nadpis">#</a></small></h2>
<p>Člověk, který už nějakou chvíli s Node.js pracuje, by si řekl, že tohle všechno jde nejspíš doplnit přes balíčky na npm. Jak jsem už naznačil, kvůli chybějící poptávce to není úplně růžové. Když už balíčky vůbec existují, <a href="https://github.com/jpstevens/mocha-shared">mají do deseti commitů a posledním z nich proběhl před dvěma roky</a>. Autoři už nejspíš dávno píšou
v <a href="http://elm-lang.org/">Elmu</a>, takže nové verze neřeší... Navíc se zdá, že balíčky pro Mochu v zásadě řeší spíš její nemoci a nedostatky. Nepřidávají vychytávky, které by vylepšovaly <em>developer experience</em>.</p>
<p>V době psaní článku je <a href="https://github.com/rstacruz/mocha-clean">mocha-clean</a> nejvíce ohvězdičkovaný doplněk pro Mochu na GitHubu. Tedy z těch, které opravdu něco přidávají - přeskočil jsem integrace typu Mocha + React, Mocha + Mongo, Mocha + prohlížeč, apod. Opravuje <em>stacktraces</em>.</p>
<p>Co jiného bych si představoval? Tak třeba <a href="https://github.com/tarpas/pytest-testmon/">pytest-testmon</a> je doplněk, který využívá code coverage k tomu, aby určil, jaké testy má spustit znova a jaké může nechat ležet ladem. Tzn. něco, co extrémně zvyšuje produktivitu. Žádné manuální <code>.only</code> nebo otrocké grepování.</p>
<p>A co se týče ovládání spouštění testů nebo formátu výstupu, i kdybych nakonec na npm našel něco, co mi vysněné přepínače doplní, nebude to jedna standardní implementace, standardní konvence, kterou by znal i nově příchozí kolega.</p>
<h2 id="trendy">Trendy<small class="permalink"><a href="#trendy" title="Trvalý odkaz na tento nadpis">#</a></small></h2>
<p>Článek jsem napsal jako vyústění dlouhodobé frustrace z toho, že se v JavaScriptu
musí na poli testování nejen vynalézat znova kolo, ale že ho ani nikdo nevynalézá.
Ani módní výstřelky typu <a href="https://github.com/avajs/ava">AVA</a> proti <a href="https://en.wikipedia.org/wiki/Spaghetti_code">špagetám</a> nebrojí. Už podle
<code>README</code> nevidím, že by se řešilo cokoliv z mnou nastíněných problémů. AVA vypadá jako
Mocha s jinou syntaxí, ještě méně features (tzn. bude vyžadovat nový ekosystém
<code>ava-*</code> balíčků na npm) a jednou jedinou <em>killer feature</em>, což jsou asynchronní testy
(Promises, async/await). To samozřejmě pytest nemá...</p>
<p><a href="https://pypi.python.org/pypi/pytest-asyncio">Oh await!</a></p>
<p>No dobře, nebudu tak zlý. AVA vede k izolaci testů a extrémně zrychluje dobu běhu test suite. Uznávám,
vypadá to hodně dobře. Není tam jinak ale nic, co reálně ovlivňuje jednoduchost psaní složitějších testů. Autoři sice spálili hromadu času na tom, aby to jelo se všema Babelama a Reactama
a TypeScriptem, ale to nejsou věci, které mi ušetří čas při psaní testů, to
jsou šaškárny JavaScript ekosystému, za které nemůžu, a jako prostého uživatele mě moc nezajímají.</p>
<h2 id="tldr">TL;DR<small class="permalink"><a href="#tldr" title="Trvalý odkaz na tento nadpis">#</a></small></h2>
<p>Abych to shrnul, na testování v JavaScriptu mě štvou dvě věci:</p>
<ul>
<li>Asserty jako jsou v pytestu (nebo deklarativnost pomocí dekorátorů,
ale ty možná JavaScript už má nebo mít bude) nikdo neudělá kvůli omezením jazyka.</li>
<li>Jestli je AVA následovníkem Mochy, tak JavaScriptové frameworky nesměřují
k jednoduššímu a pohodlnějšímu psaní testů, ale k jejich rychlejšímu spouštění díky paralelizaci (palec nahoru) a
<em>frikulínství as a feature</em> (palec dolů). Nikde na obzoru nevidím ani tak základní
věc, jako je <em>namakanější spouštěč testů</em>, což bylo něco, čím Python žil před lety
a dnes je to komodita. To, čím Python žije dnes - jak psát strukturovanější,
spravovatelnější a čitelnější kód testů, vypadá ve srovnání s JavaScriptem jako velmi vzdálené
<em>first world problems</em>. Jsem smutný, že to v JavaScriptu nikomu nechybí, ale chápu, že je to asi jako
propagovat třídění odpadu v Súdánu.</li>
</ul>
<p><strong>Reklama:</strong> Většinu vědomostí o testování v Pythonu jsem načerpal na <a href="http://pyvo.cz/">Pyvech</a>, srazech Python programátorů, a to především na nedávném <a href="http://pyvo.cz/praha">pražském</a>, které bylo přímo na téma testování. Pokud chcete být tak chytří jako já, choďte na Pyvo.</p>
<p><em>Tento článek jsem napsal z čiré frustrace, původně jen jako <a href="https://gist.github.com/honzajavorek/fc3279273dbffa7416ce384fa614cd1f">cár Markdownu, úplně mimo blog</a>.
Sem byl přepsán v lednu 2017 a posléze přeložen do angličtiny jako <a href="https://honzajavorek.cz/blog/testing-in-javascript-and-in-python">Testing in JavaScript
and Python</a>.</em></p></div>
  </div>
  <footer class="article-footer">
    <div id="author" class="author">
      <img alt="Honza Javorek's photo" src="https://honzajavorek.cz/images/home/honza.jpg">
      <address>
          <a href="https://honzajavorek.cz">Honza Javorek</a> je programátor
          a tvůrce projektu <a href="https://junior.guru/">junior.guru</a>,
          pomáhajícího lidem získat svou první práci v IT. Od roku 2011
          pomáhá budovat českou komunitu kolem jazyka
          <a href="https://python.cz/">Python</a>.
      </address>
    </div>
    <p class="button">
        <a href="https://honzajavorek.cz/blog/">
          <i class="fa fa-list-ul"></i> Archiv článků
        </a>
    </p>
  </footer>
</article>
      </div>
      <footer class="footer">
        <address>
          © Copyright 2007—2020
          <a href="https://honzajavorek.cz">Honza&nbsp;Javorek</a>
        </address>
      </footer>
    <script defer src="https://honzajavorek.cz/theme/main.js"></script>
    <script defer src="https://honzajavorek.cz/theme/instant.page/instantpage.js"></script>
  </body>
</html>